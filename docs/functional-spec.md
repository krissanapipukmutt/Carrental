# เอกสารข้อกำหนดเชิงหน้าที่ (Functional Specification)

## 1. ขอบเขตระบบ
ระบบ “Car Rental Manager” ช่วยให้พนักงานจัดการวงจรการเช่ารถตั้งแต่การลงทะเบียนลูกค้า สร้างสัญญา รับ-คืนรถ บันทึกการซ่อมบำรุง ไปจนถึงติดตามรายได้ผ่านรายงานแบบเรียลไทม์ โดยแยกสิทธิ์ผู้ใช้งานเป็นบทบาท (Role) ตามหน้าที่

## 2. บทบาทผู้ใช้งาน
| บทบาท | สิทธิ์หลัก | รายละเอียด |
|--------|-------------|-------------|
| **Manager** | CRUD ลูกค้า/รถ/สัญญา/พนักงาน, ดูทุกหน้ารายงาน, อนุมัติส่วนลด | ควบคุมภาพรวมทุกสาขา |
| **Rental Agent** | จัดการลูกค้า, สัญญาเช่า, รับชำระ, ตรวจสภาพรถ | ทำงานประจำเคาน์เตอร์ |
| **Mechanic** | บันทึก/อัปเดตงานซ่อมบำรุง, ดูประวัติรถ | ไม่มีสิทธิ์ด้านการเงิน |
| **Finance/Admin** _(เติมภายหลัง)_ | จัดการรายงานการเงิน, ส่งออกเอกสาร | เข้าถึงข้อมูลสัญญาและการชำระเงิน |
| **Customer** _(ทางเลือก)*_ | อ่านประวัติการเช่า/ใบเสร็จ | ใช้ Supabase Auth + Policy |

## 3. โมดูลหลัก
### 3.1 การจัดการลูกค้า
- ฟอร์มเพิ่ม/แก้ไขลูกค้า: ข้อมูลติดต่อ, ใบขับขี่, วันหมดอายุ, เบอร์โทร
- รายการลูกค้าพร้อมจำนวนสัญญาที่เคยเช่า
- ค้นหา/จัดเรียงตามชื่อ อีเมล เบอร์โทร
- (อนาคต) เอกสารแนบ/สำเนาบัตรใน Supabase Storage

### 3.2 การจัดการฟลีทรถ
- บันทึกคุณสมบัติรถ: ยี่ห้อ รุ่น ปี สี หมวดหมู่ สาขา
- สถานะรถ: `available`, `reserved`, `rented`, `maintenance`, `retired`
- แสดงประวัติซ่อมล่าสุด, เลขไมล์, ค่าเช่าต่อวัน
- เปลี่ยนสถานะรถผ่าน server action (พร้อม Revalidate)

### 3.3 สัญญาเช่า (Rental Contracts)
- สร้างสัญญาใหม่ด้วยขั้นตอน:
  1. เลือกลูกค้า
  2. เลือกรถ (กรองเฉพาะ `available`)
  3. กำหนดช่วงเวลา + ค่าเช่า + ส่วนลด + มัดจำ
  4. เลือกวิธีชำระ (บันทึกลง `payments`)
- ระบบสร้างหมายเลขสัญญาอัตโนมัติ (รูปแบบ `CR-YYYY-XXXX`)
- สถานะสัญญา: `pending`, `active`, `completed`, `cancelled`, `overdue`
- เมื่อสัญญา active จะอัปเดตสถานะรถเป็น `reserved`/`rented` อัตโนมัติ

### 3.4 การชำระเงิน (Payments)
- ประเภทชำระ: `deposit`, `rental_fee`, `late_fee`, `refund`
- เก็บข้อมูลวันที่, วิธีชำระ, เลขอ้างอิง, พนักงานที่รับเงิน
- ใช้ข้อมูลสร้างรายงานรายได้และสรุป Contract Balance

### 3.5 การซ่อมบำรุง (Maintenance Records)
- บันทึกประเภทงานซ่อม (ตามสกีมาที่กำหนด) ค่าซ่อม เลขไมล์ ผู้ปฏิบัติ
- แจ้งเตือน/Flag รถที่มีงานซ่อมค้างหรือเกินกำหนด (เฟสถัดไปสามารถเพิ่ม scheduler)
- เชื่อมโยงกับรายงาน `mv_maintenance_history`

### 3.6 การตรวจสภาพรถ (Rental Inspections)
- ฟอร์มบันทึกตอนรับ/คืนรถ: รูปภาพ, ความเสียหาย, น้ำมัน, เลขไมล์
- ใช้ JSONB เก็บข้อมูลรายละเอียดความเสียหาย พร้อมแนบไฟล์ใน Storage

### 3.7 รายงาน (Reports)
| รายงาน | แหล่งข้อมูล | คำอธิบาย |
|--------|--------------|----------|
| รายได้ต่อเดือน | `mv_revenue_by_period` | สรุปรายได้ค่าเช่า/ค่าปรับ/มัดจำ/คืนเงิน |
| อัตราการใช้งานรถ | `mv_car_utilization` | 90 วันย้อนหลัง, แสดง % การใช้งาน/จำนวนวันที่เช่า |
| ลูกค้าท็อป | `mv_top_customers` | เรียงตามจำนวนครั้งที่เช่าและยอดใช้จ่าย |
| ประวัติซ่อมบำรุง | `mv_maintenance_history` | จำนวนงานซ่อมและต้นทุนรวมต่อรถ |
| สัญญาค้างคืน | `mv_overdue_rentals` | สัญญาที่สถานะ overdue พร้อมวันค้างและค่าปรับ |

## 4. ฟังก์ชันเชิงตรรกะ (Server Actions / API)
| ฟังก์ชัน | เส้นทาง/ไฟล์ | บทบาทที่ใช้ | คำอธิบาย |
|----------|---------------|--------------|-----------|
| `createCar` | `app/cars/actions.ts` | Manager | เพิ่มรถใหม่ ปรับ Revalidate `/cars` |
| `updateCarStatus` | `app/cars/actions.ts` | Manager, Mechanic | เปลี่ยนสถานะรถ (พร้อม Guard) |
| `createRental` | `app/rentals/actions.ts` | Rental Agent | สร้างสัญญา + บันทึกมัดจำ + อัปเดตรถ |
| (ภายหน้าจะเพิ่ม) `completeRental`, `cancelRental`, `addInspection`, `recordPayment`, `scheduleMaintenance` |

## 5. กฎทางธุรกิจ (Business Rules)
1. รถ 1 คันมีสัญญา active พร้อมกันได้ไม่เกิน 1 ฉบับ (จำกัดผ่าน status check)
2. สถานะ `overdue` คำนวณจาก `return_datetime < now()` และยังไม่ completed
3. บันทึกมัดจำต้องเกิดพร้อมการสร้างสัญญา หากมีค่า `deposit_amount`
4. เลขไมล์ (`mileage`, `odometer`) ต้องไม่ลดลงเมื่อลงข้อมูลใหม่
5. RLS: พนักงานเห็นเฉพาะข้อมูลในสาขาตนเอง (config ผ่าน Supabase policy)

## 6. การตรวจสอบและการทดสอบ
- **Unit Test:** ฟังก์ชันคำนวณยอด, สคริปต์สร้างหมายเลขสัญญา
- **Integration Test:** สร้างสัญญา -> อัปเดตรถ -> บันทึกชำระ -> ปิดสัญญา
- **UI Regression:** ตรวจตารางรายงาน (sorting/filter รวดเร็ว), การ revalidate หน้า

## 7. ข้อกำหนดไม่เชิงหน้าที่ (NFR)
| หมวด | ข้อกำหนด |
|------|-----------|
| Performance | Response < 2s สำหรับการดูข้อมูล, < 3s สำหรับรายงาน |
| Availability | 99% uptime บน Vercel + Supabase |
| Security | RLS + JWT, บันทึกประวัติการใช้งาน (Audit log เฟสถัดไป) |
| Maintainability | ใช้ TypeScript, ESLint, แยกโมดูล, CI lint/build |
| Localization | สนับสนุนภาษาไทยเต็มรูปแบบ (วันที่/สกุลเงิน) |

## 8. แผนพัฒนาเพิ่มเติม (Backlog)
- ระบบแจ้งเตือนกำหนดคืนรถทางอีเมล/LINE
- แผนซ่อมบำรุงอัตโนมัติตามระยะทาง
- Export รายงาน CSV/PDF
- Mobile-friendly view สำหรับเจ้าหน้าที่ภาคสนาม

---
> เอกสารนี้อธิบายพฤติกรรมของระบบในมุมมองผู้ใช้และกฎธุรกิจ เพื่อเป็นแม่แบบในการออกแบบเชิงเทคนิคและการทดสอบ
